<!DOCTYPE html>
<html dir="ltr" class="js desktop" lang="en"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <title>xenon:xenon1t:aalbers:straxferno [XENON1TWiki]</title>
    <script>(function(H){H.className=H.className.replace(/\bno-js\b/,'js')})(document.documentElement)</script>
    <meta name="generator" content="DokuWiki">
<meta name="theme-color" content="#008800">
<meta name="robots" content="index,follow">
<meta name="keywords" content="xenon,xenon1t,aalbers,straxferno">
<link rel="search" type="application/opensearchdescription+xml" href="https://xe1t-wiki.lngs.infn.it/lib/exe/opensearch.php" title="XENON1TWiki">
<link rel="start" href="https://xe1t-wiki.lngs.infn.it/">
<link rel="contents" href="https://xe1t-wiki.lngs.infn.it/doku.php?id=xenon:xenon1t:aalbers:straxferno&amp;do=index" title="Sitemap">
<link rel="manifest" href="https://xe1t-wiki.lngs.infn.it/lib/exe/manifest.php">
<link rel="alternate" type="application/rss+xml" title="Recent Changes" href="https://xe1t-wiki.lngs.infn.it/feed.php">
<link rel="alternate" type="application/rss+xml" title="Current namespace" href="https://xe1t-wiki.lngs.infn.it/feed.php?mode=list&amp;ns=xenon:xenon1t:aalbers">
<link rel="edit" title="Edit this page" href="https://xe1t-wiki.lngs.infn.it/doku.php?id=xenon:xenon1t:aalbers:straxferno&amp;do=edit">
<link rel="alternate" type="text/html" title="Plain HTML" href="https://xe1t-wiki.lngs.infn.it/doku.php?do=export_xhtml&amp;id=xenon:xenon1t:aalbers:straxferno">
<link rel="alternate" type="text/plain" title="Wiki Markup" href="https://xe1t-wiki.lngs.infn.it/doku.php?do=export_raw&amp;id=xenon:xenon1t:aalbers:straxferno">
<link rel="canonical" href="https://xe1t-wiki.lngs.infn.it/doku.php?id=xenon:xenon1t:aalbers:straxferno">
<link rel="stylesheet" type="text/css" href="course_info_files/css.css">
<!--[if gte IE 9]><!-->
<script type="text/javascript">/*<![CDATA[*/var NS='xenon:xenon1t:aalbers';var SIG=' --- //[[jaalbers@nikhef.nl|Jelle Aalbers]] 2020/08/28 19:08//';var JSINFO = {"move_renameokay":true,"id":"xenon:xenon1t:aalbers:straxferno","namespace":"xenon:xenon1t:aalbers","ACT":"show","useHeadingNavigation":0,"useHeadingContent":0};
/*!]]>*/</script>
<script type="text/javascript" charset="utf-8" src="course_info_files/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="course_info_files/js.js"></script><style id="iris-css">.iris-picker{display:block;position:relative}.iris-picker,.iris-picker *{-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}input+.iris-picker{margin-top:4px}.iris-error{background-color:#ffafaf}.iris-border{border-radius:3px;border:1px solid #aaa;width:200px;background-color:#fff}.iris-picker-inner{position:absolute;top:0;right:0;left:0;bottom:0}.iris-border .iris-picker-inner{top:10px;right:10px;left:10px;bottom:10px}.iris-picker .iris-square-inner{position:absolute;left:0;right:0;top:0;bottom:0}.iris-picker .iris-square,.iris-picker .iris-slider,.iris-picker .iris-square-inner,.iris-picker .iris-palette{border-radius:3px;box-shadow:inset 0 0 5px rgba(0,0,0,.4);height:100%;width:12.5%;float:left;margin-right:5%}.iris-picker .iris-square{width:76%;margin-right:10%;position:relative}.iris-picker .iris-square-inner{width:auto;margin:0}.iris-ie-9 .iris-square,.iris-ie-9 .iris-slider,.iris-ie-9 .iris-square-inner,.iris-ie-9 .iris-palette{box-shadow:none;border-radius:0}.iris-ie-9 .iris-square,.iris-ie-9 .iris-slider,.iris-ie-9 .iris-palette{outline:1px solid rgba(0,0,0,.1)}.iris-ie-lt9 .iris-square,.iris-ie-lt9 .iris-slider,.iris-ie-lt9 .iris-square-inner,.iris-ie-lt9 .iris-palette{outline:1px solid #aaa}.iris-ie-lt9 .iris-square .ui-slider-handle{outline:1px solid #aaa;background-color:#fff;-ms-filter:"alpha(Opacity=30)"}.iris-ie-lt9 .iris-square .iris-square-handle{background:0;border:3px solid #fff;-ms-filter:"alpha(Opacity=50)"}.iris-picker .iris-strip{margin-right:0;position:relative}.iris-picker .iris-strip .ui-slider-handle{position:absolute;background:0;margin:0;right:-3px;left:-3px;border:4px solid #aaa;border-width:4px 3px;width:auto;height:6px;border-radius:4px;box-shadow:0 1px 2px rgba(0,0,0,.2);opacity:.9;z-index:5;cursor:ns-resize}.iris-strip .ui-slider-handle:before{content:" ";position:absolute;left:-2px;right:-2px;top:-3px;bottom:-3px;border:2px solid #fff;border-radius:3px}.iris-picker .iris-slider-offset{position:absolute;top:11px;left:0;right:0;bottom:-3px;width:auto;height:auto;background:transparent;border:0;border-radius:0}.iris-picker .iris-square-handle{background:transparent;border:5px solid #aaa;border-radius:50%;border-color:rgba(128,128,128,.5);box-shadow:none;width:12px;height:12px;position:absolute;left:-10px;top:-10px;cursor:move;opacity:1;z-index:10}.iris-picker .ui-state-focus .iris-square-handle{opacity:.8}.iris-picker .iris-square-handle:hover{border-color:#999}.iris-picker .iris-square-value:focus .iris-square-handle{box-shadow:0 0 2px rgba(0,0,0,.75);opacity:.8}.iris-picker .iris-square-handle:hover::after{border-color:#fff}.iris-picker .iris-square-handle::after{position:absolute;bottom:-4px;right:-4px;left:-4px;top:-4px;border:3px solid #f9f9f9;border-color:rgba(255,255,255,.8);border-radius:50%;content:" "}.iris-picker .iris-square-value{width:8px;height:8px;position:absolute}.iris-ie-lt9 .iris-square-value,.iris-mozilla .iris-square-value{width:1px;height:1px}.iris-palette-container{position:absolute;bottom:0;left:0;margin:0;padding:0}.iris-border .iris-palette-container{left:10px;bottom:10px}.iris-picker .iris-palette{margin:0;cursor:pointer}.iris-square-handle,.ui-slider-handle{border:0;outline:0}</style>
<!--<![endif]-->
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="shortcut icon" href="https://xe1t-wiki.lngs.infn.it/lib/tpl/dokuwiki/images/favicon.ico">
<link rel="apple-touch-icon" href="https://xe1t-wiki.lngs.infn.it/lib/tpl/dokuwiki/images/apple-touch-icon.png">
    </head>

<body>
    <div id="dokuwiki__site"><div id="dokuwiki__top" class="site dokuwiki mode_show tpl_dokuwiki loggedIn    ">

        
<!-- ********** HEADER ********** -->
<div id="dokuwiki__header"><div class="pad group">

    
    <div class="headings group">
        <ul class="a11y skip">
            <li><a href="#dokuwiki__content">skip to content</a></li>
        </ul>

        <h1><a href="https://xe1t-wiki.lngs.infn.it/doku.php?id=xenon" accesskey="h" title="[H]"><img src="course_info_files/logo.png" alt="" width="64" height="64"> <span>XENON1TWiki</span></a></h1>
            </div>

    <div class="tools group">
        <!-- USER TOOLS -->
                    <div id="dokuwiki__usertools">
                <h3 class="a11y">User Tools</h3>
                <ul>
                    <li class="user">Logged in as: <bdi>Jelle Aalbers</bdi> (<bdi>aalbers</bdi>)</li><li class="action logout"><a href="https://xe1t-wiki.lngs.infn.it/doku.php?id=xenon:xenon1t:aalbers:straxferno&amp;do=logout&amp;sectok=3977a5cb130ea4d9e0fe48f816961733" title="Log Out" rel="nofollow"><span>Log Out</span><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M17 17.25V14h-7v-4h7V6.75L22.25 12 17 17.25M13 2a2 2 0 0 1 2 2v4h-2V4H4v16h9v-4h2v4a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9z"></path></svg></a></li>                </ul>
            </div>
        
        <!-- SITE TOOLS -->
        <div id="dokuwiki__sitetools">
            <h3 class="a11y">Site Tools</h3>
            <form action="/doku.php?id=xenon" method="get" role="search" class="search doku_form" id="dw__search" accept-charset="utf-8"><input type="hidden" name="do" value="search"><input type="hidden" name="id" value="xenon:xenon1t:aalbers:straxferno"><div class="no"><input name="q" type="text" class="edit" title="[F]" accesskey="f" placeholder="Search" autocomplete="on" id="qsearch__in"><button value="1" type="submit" title="Search">Search</button><div id="qsearch__out" class="ajax_qsearch JSpopup" style="display: none;"></div></div></form>            <div class="mobileTools">
                <form action="/doku.php" method="get" accept-charset="utf-8"><div class="no"><input type="hidden" name="id" value="xenon:xenon1t:aalbers:straxferno"><input type="hidden" name="sectok" value="3977a5cb130ea4d9e0fe48f816961733"><select name="do" class="edit quickselect" title="Tools"><option value="" selected="selected">Tools</option><optgroup label="Page Tools"><option value="edit">Edit this page</option><option value="revisions">Old revisions</option><option value="export_pdf">Export to PDF</option><option value="menuitem">Rename Page</option><option value="backlink">Backlinks</option></optgroup><optgroup label="Site Tools"><option value="recent">Recent Changes</option><option value="media">Media Manager</option><option value="index">Sitemap</option></optgroup><optgroup label="User Tools"><option value="logout">Log Out</option></optgroup></select><button type="submit" style="display: none;">&gt;</button></div></form>            </div>
            <ul>
                <li class="action recent"><a href="https://xe1t-wiki.lngs.infn.it/doku.php?id=xenon:xenon1t:aalbers:straxferno&amp;do=recent" title="Recent Changes [r]" rel="nofollow" accesskey="r">Recent Changes</a></li><li class="action media"><a href="https://xe1t-wiki.lngs.infn.it/doku.php?id=xenon:xenon1t:aalbers:straxferno&amp;do=media&amp;ns=xenon%3Axenon1t%3Aaalbers" title="Media Manager" rel="nofollow">Media Manager</a></li><li class="action index"><a href="https://xe1t-wiki.lngs.infn.it/doku.php?id=xenon:xenon1t:aalbers:straxferno&amp;do=index" title="Sitemap [x]" rel="nofollow" accesskey="x">Sitemap</a></li>            </ul>
        </div>

    </div>

    <!-- BREADCRUMBS -->
            <div class="breadcrumbs">
                                        <div class="trace"><span class="bchead">Trace:</span> <span class="bcsep">•</span> <span class="curid"><bdi><a href="https://xe1t-wiki.lngs.infn.it/doku.php?id=xenon:xenon1t:aalbers:straxferno" class="breadcrumbs" title="xenon:xenon1t:aalbers:straxferno">straxferno</a></bdi></span></div>
                    </div>
    


    <hr class="a11y">
</div></div><!-- /header -->

        <div class="wrapper group">

            
            <!-- ********** CONTENT ********** -->
            <div id="dokuwiki__content"><div class="pad group">
                
                <div class="pageId"><span>xenon:xenon1t:aalbers:straxferno</span></div>

                <div class="page group">
                                                            <!-- wikipage start -->
                    <!-- TOC START -->
<div id="dw__toc" class="dw__toc">
<h3 class="toggle open" style="cursor: pointer;"><strong><span>−</span></strong>Table of Contents</h3>
<div style="" aria-expanded="true">

<ul class="toc">
<li class="level1"><div class="li"><a href="#straxfernoa_perilous_journey_to_the_heart_of_our_analysis_framework">Straxferno: a Perilous Journey to the Heart of our Analysis Framework</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="#vestibule">Vestibule</a></div>
<ul class="toc">
<li class="level3"><div class="li"><a href="#circle_0using_strax">Circle 0: Using strax</a></div></li>
</ul>
</li>
<li class="level2"><div class="li"><a href="#outer_circles">Outer circles</a></div>
<ul class="toc">
<li class="level3"><div class="li"><a href="#circle_1high-level_processing">Circle 1: High-level processing</a></div></li>
<li class="level3"><div class="li"><a href="#circle_2low-level_processing">Circle 2: Low-level processing</a></div></li>
<li class="level3"><div class="li"><a href="#circle_3loading_data_and_mini-analyses">Circle 3: Loading data and mini-analyses</a></div></li>
<li class="level3"><div class="li"><a href="#circle_4contexts_run_selection_and_configuration">Circle 4: Contexts, run selection, and configuration</a></div></li>
<li class="level3"><div class="li"><a href="#circle_5the_storage_system">Circle 5: The storage system</a></div></li>
</ul>
</li>
<li class="level2"><div class="li"><a href="#inner_circles">Inner circles</a></div>
<ul class="toc">
<li class="level3"><div class="li"><a href="#circle_6chunks_and_plugins">Circle 6: Chunks and plugins</a></div></li>
<li class="level3"><div class="li"><a href="#circle_7data_flow">Circle 7: Data flow</a></div></li>
<li class="level3"><div class="li"><a href="#circle_8processing_initialization">Circle 8: Processing initialization</a></div></li>
<li class="level3"><div class="li"><a href="#circle_9mailboxes_and_the_threadedmailboxprocessor">Circle 9: Mailboxes and the ThreadedMailboxProcessor</a></div></li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
<!-- TOC END -->

<h1 class="sectionedit1" id="straxfernoa_perilous_journey_to_the_heart_of_our_analysis_framework">Straxferno: a Perilous Journey to the Heart of our Analysis Framework</h1>
<div class="level1">

<p>
<span style="color:red; ">Recordings of earlier sessions can be found in /project2/lgrandi/strax_tutorial</span>
</p>

<p>
<span style="color:red; ">Find materials in the course repository <a href="https://github.com/XENONnT/straxferno" class="urlextern" title="https://github.com/XENONnT/straxferno" rel="nofollow">here</a></span>
</p>

</div>

<h5 id="introduction">Introduction</h5>
<div class="level5">

<p>
<em>Sign up <a href="https://docs.google.com/forms/d/e/1FAIpQLSe8nmtmQBSJrGts4MLfs6HBEZkjwvEd7ANC3DL95H_LSTJIKg/viewform?usp=sf_link" class="urlextern" title="https://docs.google.com/forms/d/e/1FAIpQLSe8nmtmQBSJrGts4MLfs6HBEZkjwvEd7ANC3DL95H_LSTJIKg/viewform?usp=sf_link" rel="nofollow">here</a> before the technical meeting.</em>
</p>

<p>
This is an online course on strax, where we dive deeper and deeper into 
the details that make our analysis framework go. The level increases 
throughout the course. 
</p>

<p>
To get the most out of this course, expect to spend 5-10 hours a week. 
Each week has a 1-1.5 hour discussion section, a few hours of reading, 
and exercises which will take several hours to complete. 
Everyone is welcome to participate, even if you only have time to attend
 the discussion section.
</p>

<p>
In detail, we have:
</p>
<ul>
<li class="level1 node"><div class="li"> <strong>Discussion</strong>: a 1 to 1.5 hour <a href="https://columbiauniversity.zoom.us/j/182483370" class="urlextern" title="https://columbiauniversity.zoom.us/j/182483370" rel="nofollow">zoom</a>
 session in which we discuss the material together. Bring questions!! 
This is NOT a lecture, Jelle is far too lazy to make ten hour-long 
presentations, and it would not help you learn well anyway. </div>
<ul>
<li class="level2"><div class="li"> We understand there are no timeslots
 that are convenient for everyone in the collaboration. The sessions 
will be recorded so you can rewatch them. Feel free to discuss in the <a href="https://github.com/AxFoundation/strax" class="urlextern" title="https://github.com/AxFoundation/strax" rel="nofollow">strax</a> chat too.</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> <strong>Reading</strong>: usually 
code from strax(en), but sometimes technical documentation. For optimal 
results, go through this before the discussion session – but don't be 
too shy to attend discussion if you couldn't.</div>
</li>
<li class="level1"><div class="li"> <strong>Study questions</strong>: questions to guide the reading. We will discuss these in the discussion section.</div>
</li>
<li class="level1"><div class="li"> <strong>Exercises</strong>: You can 
do these before or after the discussion section to help advance your 
understanding. 'Official' solutions might become available after the 
discussion, but you are more than welcome to share your own solutions in
 the <a href="https://github.com/XENONnT/straxferno" class="urlextern" title="https://github.com/XENONnT/straxferno" rel="nofollow">course repo</a>!</div>
</li>
</ul>

</div>

<h5 id="prerequisites">Prerequisites</h5>
<div class="level5">

<p>
We assume you are already familiar with python, to the point that you know idioms such as dictionary comprehensions, <code>**kwargs</code>, and simple classes. If you're not, see the list of <a href="https://github.com/hsf-training/PyHEP-resources" class="urlextern" title="https://github.com/hsf-training/PyHEP-resources" rel="nofollow">Python training and resource materials</a>, from the High-Energy Physics Software Foundation.
</p>

</div>

<h5 id="why_is_it_called_straxferno_what_is_all_this_circle_stuff_about">Why is it called straxferno? What is all this 'circle' stuff about?</h5>
<div class="level5">

<p>
It is an <a href="https://en.wikipedia.org/wiki/Inferno_(Dante)" class="urlextern" title="https://en.wikipedia.org/wiki/Inferno_(Dante)" rel="nofollow">allegory</a>
</p>

</div>

<h5 id="schedule">Schedule</h5>
<div class="level5">
<div class="table sectionedit2"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0"> Session </th><th class="col1"> Date </th><th class="col2"> Intro slides </th><th class="col3"> Recording </th>
	</tr>
	</thead>
	<tbody><tr class="row1">
		<td class="col0"> 0: Using strax </td><td class="col1"> Friday 15 May 14:30 </td><td class="col2"> <a href="https://github.com/XENONnT/straxferno/blob/master/0_using_strax/0_intro.pdf" class="urlextern" title="https://github.com/XENONnT/straxferno/blob/master/0_using_strax/0_intro.pdf" rel="nofollow">Link</a> </td><td class="col3"> <code>/project2/lgrandi/strax_tutorial/0_using_strax.mp4</code> </td>
	</tr>
	<tr class="row2">
		<td class="col0"> 1: High-level processing </td><td class="col1"> Tuesday 19 May 15:00 </td><td class="col2"> <a href="https://github.com/XENONnT/straxferno/blob/master/1_high_level_processing/1_high_level_processing.pdf" class="urlextern" title="https://github.com/XENONnT/straxferno/blob/master/1_high_level_processing/1_high_level_processing.pdf" rel="nofollow">Link</a> </td><td class="col3"> <code>/project2/lgrandi/strax_tutorial/1_high_level_processing.mp4</code> </td>
	</tr>
	<tr class="row3">
		<td class="col0"> 2: Low-level processing</td><td class="col1"> Tuesday 26 May 15:00 </td><td class="col2"> <a href="https://github.com/XENONnT/straxferno/blob/master/2_low_level_processing/2_low_level_processing.pdf" class="urlextern" title="https://github.com/XENONnT/straxferno/blob/master/2_low_level_processing/2_low_level_processing.pdf" rel="nofollow">Link</a> </td><td class="col3"> <code>/project2/lgrandi/strax_tutorial/2_low_level_processing.mp4</code> </td>
	</tr>
	<tr class="row4">
		<td class="col0"> 3: Loading data and mini-analyses </td><td class="col1"> Tuesday 2 June 15:00 </td><td class="col2 leftalign">  </td><td class="col3"> <code>/project2/lgrandi/strax_tutorial/3_data_loading_and_mini_analysis.mp4</code> </td>
	</tr>
	<tr class="row5">
		<td class="col0"> 4: Contexts, run selection, configuration </td><td class="col1"> Tuesday 9 June 15:00 </td><td class="col2"> <a href="https://github.com/XENONnT/straxferno/blob/master/4_contexts_selection_configuration/straxferno_4_contexts_selection_configuration.pdf" class="urlextern" title="https://github.com/XENONnT/straxferno/blob/master/4_contexts_selection_configuration/straxferno_4_contexts_selection_configuration.pdf" rel="nofollow">link</a> </td><td class="col3"> <code>/project2/lgrandi/strax_tutorial/4_context_runs_configuration.mp4</code> </td>
	</tr>
	<tr class="row6">
		<td class="col0"> 5: Storage </td><td class="col1"> Tuesday 16 June 15:00 </td><td class="col2"> <a href="https://github.com/XENONnT/straxferno/blob/master/5_storage/straxferno_5_storage.pdf" class="urlextern" title="https://github.com/XENONnT/straxferno/blob/master/5_storage/straxferno_5_storage.pdf" rel="nofollow">link</a> </td><td class="col3"> <code>/project2/lgrandi/strax_tutorial/5_storage_system.mp4</code> </td>
	</tr>
	<tr class="row7">
		<td class="col0"> 6: Plugin implementation</td><td class="col1"> Tuesday 23 June 15:00 </td><td class="col2"> </td><td class="col3"> <code>/project2/lgrandi/strax_tutorial/6_plugins.mp4</code> </td>
	</tr>
	<tr class="row8">
		<td class="col0"> 7: Data flow </td><td class="col1"> Tuesday 30 June 15:00 </td><td class="col2"> </td><td class="col3"> <code>/project2/lgrandi/strax_tutorial/7_dataflow.mp4</code> </td>
	</tr>
	<tr class="row9">
		<td class="col0"> 8: Processing setup </td><td class="col1"> Tuesday 7 July 15:00 </td><td class="col2"> </td><td class="col3"> <code>/project2/lgrandi/strax_tutorial/8_processing_setup.mp4</code> </td>
	</tr>
	<tr class="row10">
		<td class="col0"> 9: Mailboxes </td><td class="col1"> Tuesday 14 July 15:00 </td><td class="col2"> <a href="https://github.com/XENONnT/straxferno/blob/master/9_mailboxes/straxferno_9_mailboxes.pdf" class="urlextern" title="https://github.com/XENONnT/straxferno/blob/master/9_mailboxes/straxferno_9_mailboxes.pdf" rel="nofollow">Link</a> </td><td class="col3"> <code>/project2/lgrandi/strax_tutorial/9_mailboxes.mp4</code> </td>
	</tr>
</tbody></table></div>

</div>
<div class="secedit editbutton_section editbutton_1"><form class="button btn_secedit" method="post" action="/doku.php"><div class="no"><input type="hidden" name="do" value="edit"><input type="hidden" name="rev" value="1595252004"><input type="hidden" name="summary" value="[Straxferno: a Perilous Journey to the Heart of our Analysis Framework] "><input type="hidden" name="target" value="section"><input type="hidden" name="hid" value="straxfernoa_perilous_journey_to_the_heart_of_our_analysis_framework"><input type="hidden" name="codeblockOffset" value="0"><input type="hidden" name="range" value="1-4457"><input type="hidden" name="id" value="xenon:xenon1t:aalbers:straxferno"><button type="submit" title="Straxferno: a Perilous Journey to the Heart of our Analysis Framework">Edit</button></div></form></div>
<h2 class="sectionedit3" id="vestibule">Vestibule</h2>
<div class="level2">

</div>
<div class="secedit editbutton_section editbutton_3"><form class="button btn_secedit" method="post" action="/doku.php"><div class="no"><input type="hidden" name="do" value="edit"><input type="hidden" name="rev" value="1595252004"><input type="hidden" name="summary" value="[Vestibule] "><input type="hidden" name="target" value="section"><input type="hidden" name="hid" value="vestibule"><input type="hidden" name="codeblockOffset" value="0"><input type="hidden" name="range" value="4458-4480"><input type="hidden" name="id" value="xenon:xenon1t:aalbers:straxferno"><button type="submit" title="Vestibule">Edit</button></div></form></div>
<h3 class="sectionedit4" id="circle_0using_strax">Circle 0: Using strax</h3>
<div class="level3">

<p>
This is a preparatory session to go over the main points of <em>using</em> strax for anyone interested.
</p>

<p>
Reading:
</p>
<ul>
<li class="level1"><div class="li"> <a href="https://xe1t-wiki.lngs.infn.it/doku.php?id=xenon:xenonnt:analysis:guide" class="wikilink1" title="xenon:xenonnt:analysis:guide">Analysis guide</a> (if you have not read it already)</div>
</li>
<li class="level1 node"><div class="li"> <a href="https://docs.google.com/presentation/d/1xfJE98DtYTdIJVqJ3Zf5mpHKxSDvwbRQfUJ3xgnFfiI" class="urlextern" title="https://docs.google.com/presentation/d/1xfJE98DtYTdIJVqJ3Zf5mpHKxSDvwbRQfUJ3xgnFfiI" rel="nofollow">Strax presentation</a> (slides 1-11)</div>
<ul>
<li class="level2"><div class="li"> <a href="https://docs.google.com/presentation/d/1X4R6fgSM85cRcuKspHuZCvQm2KDJDHRRVt7iaUn_8ck" class="urlextern" title="https://docs.google.com/presentation/d/1X4R6fgSM85cRcuKspHuZCvQm2KDJDHRRVt7iaUn_8ck" rel="nofollow">This presentation</a> may also be useful</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> <a href="https://github.com/XENONnT/straxen/tree/master/notebooks/tutorials" class="urlextern" title="https://github.com/XENONnT/straxen/tree/master/notebooks/tutorials" rel="nofollow">Straxen tutorials</a>: strax_demo, run_selection and pulse_analysis. Try to actually <em>run</em> the notebooks: they are automatically copied to the <code>strax_tutorials</code> folder in your home directory if you've followed the analysis guide.</div>
</li>
<li class="level1"><div class="li"> <a href="https://straxe
    Support a new way of cataloguing which data is stored where (like the runs db or rucio)
    Support a new file format for storing data (e.g. csvs or ROOT trees)
    Support a different scheme of file organization, in which files for different runs are more or less randomly scattered across different folders, though there is some file or database tracking which file is where. (This is not hypothetical, unfortunately; it is what Rucio does to our files..)

Someone give you a path to a folder which contains amazing data you want to read, unfortunately processed with some custom settings they did not tell you (and maybe some custom plugins too). How would you go about reading it in?
n.readthedocs.io/en/latest/reference/datastructure.html" class="urlextern" title="https://straxe
    Support a new way of cataloguing which data is stored where (like the runs db or rucio)
    Support a new file format for storing data (e.g. csvs or ROOT trees)
    Support a different scheme of file organization, in which files for different runs are more or less randomly scattered across different folders, though there is some file or database tracking which file is where. (This is not hypothetical, unfortunately; it is what Rucio does to our files..)

Someone give you a path to a folder which contains amazing data you want to read, unfortunately processed with some custom settings they did not tell you (and maybe some custom plugins too). How would you go about reading it in?
n.readthedocs.io/en/latest/reference/datastructure.html" rel="nofollow">Straxen datastructure</a> (skim)</div>
</li>
</ul>

<p>
Study questions:
</p>
<ul>
<li class="level1"><div class="li"> Why does your notebook crash if you try to load <code>raw_records</code> for a normal one-hour run? What options do you have available to do analysis on low-level data?</div>
</li>
<li class="level1"><div class="li"> Someone announces on gitter that the
 straxen processing algorithms have just been updated. Looking in your 
notebook, you see the data you want to load is not available anymore. 
What is the most likely cause? What options do you have for accessing 
the data anyway?</div>
</li>
<li class="level1"><div class="li"> Why can you not load <code>peak_basics</code> and <code>event_info</code> together in one <code>get_array</code> or <code>get_df</code> call? How else can you compute e.g. the sum area of S2s in an event?</div>
</li>
</ul>

<p>
Exercises:
</p>
<ul>
<li class="level1"><div class="li"> Copy the notebook <code>/home/aalbers/strax_training/elife_exercise.ipynb</code> to one of your own directories. Go through the exercises in there.</div>
</li>
</ul>

</div>
<div class="secedit editbutton_section editbutton_4"><form class="button btn_secedit" method="post" action="/doku.php"><div class="no"><input type="hidden" name="do" value="edit"><input type="hidden" name="rev" value="1595252004"><input type="hidden" name="summary" value="[Circle 0: Using strax] "><input type="hidden" name="target" value="section"><input type="hidden" name="hid" value="circle_0using_strax"><input type="hidden" name="codeblockOffset" value="0"><input type="hidden" name="range" value="4481-6847"><input type="hidden" name="id" value="xenon:xenon1t:aalbers:straxferno"><button type="submit" title="Circle 0: Using strax">Edit</button></div></form></div>
<h2 class="sectionedit5" id="outer_circles">Outer circles</h2>
<div class="level2">

</div>
<div class="secedit editbutton_section editbutton_5"><form class="button btn_secedit" method="post" action="/doku.php"><div class="no"><input type="hidden" name="do" value="edit"><input type="hidden" name="rev" value="1595252004"><input type="hidden" name="summary" value="[Outer circles] "><input type="hidden" name="target" value="section"><input type="hidden" name="hid" value="outer_circles"><input type="hidden" name="codeblockOffset" value="0"><input type="hidden" name="range" value="6848-6874"><input type="hidden" name="id" value="xenon:xenon1t:aalbers:straxferno"><button type="submit" title="Outer circles">Edit</button></div></form></div>
<h3 class="sectionedit6" id="circle_1high-level_processing">Circle 1: High-level processing</h3>
<div class="level3">

<p>
Reading:
</p>
<ul>
<li class="level1"><div class="li"> <a href="https://github.com/XENONnT/straxen/blob/master/straxen/plugins/event_processing.py" class="urlextern" title="https://github.com/XENONnT/straxen/blob/master/straxen/plugins/event_processing.py" rel="nofollow">straxen/plugins/event_processing.py</a> (406 lines)</div>
</li>
<li class="level1"><div class="li"> <a href="https://github.com/XENONnT/straxen/blob/master/straxen/plugins/peak_processing.py" class="urlextern" title="https://github.com/XENONnT/straxen/blob/master/straxen/plugins/peak_processing.py" rel="nofollow">straxen/plugins/peak_processing.py</a> (256 lines)</div>
</li>
<li class="level1"><div class="li"> <a href="https://straxen.readthedocs.io/en/latest/reference/datastructure.html" class="urlextern" title="https://straxen.readthedocs.io/en/latest/reference/datastructure.html" rel="nofollow">Straxen datastructure</a> (for reference)</div>
</li>
</ul>

<p>
Study questions:
</p>
<ul>
<li class="level1"><div class="li"> How exactly is a strax event defined? What determines what the main and alternate S1 and S2 are?</div>
</li>
<li class="level1"><div class="li"> Why does event_basics' compute function take only two arguments (beside self)? It depends on four other plugins!</div>
</li>
<li class="level1"><div class="li"> Strax applies four corrections – one
 to the position, and three to the S1 and S2 areas. Can you find where 
each of these are applied?</div>
</li>
<li class="level1"><div class="li"> What is the difference between a 
Plugin, a LoopPlugin, and an OverlapWindowPlugin? There is not much 
documentation on this, try to figure it out from the code. If it helps, 
peek at the base classes in strax/plugins.py (<a href="https://github.com/AxFoundation/strax/blob/905335d13286827a77a81cee0825f4c4a4ae81e3/strax/plugin.py#L504" class="urlextern" title="https://github.com/AxFoundation/strax/blob/905335d13286827a77a81cee0825f4c4a4ae81e3/strax/plugin.py#L504" rel="nofollow">here</a> and <a href="https://github.com/AxFoundation/strax/blob/905335d13286827a77a81cee0825f4c4a4ae81e3/strax/plugin.py#L584" class="urlextern" title="https://github.com/AxFoundation/strax/blob/905335d13286827a77a81cee0825f4c4a4ae81e3/strax/plugin.py#L584" rel="nofollow">here</a>).</div>
</li>
</ul>

<p>
Exercises:
</p>
<ul>
<li class="level1"><div class="li"> An analyst requests that we make a 
field n_hits available in peak_basics. Add the field in your custom 
straxen installation (locally or on dali/midway) and process XENON1T run
 180215_1029 to test that it works. (For extra credit, also add the time
 at which the peak's sum waveform reaches its maximum.)</div>
</li>
<li class="level1"><div class="li"> Modify the event plugins so that the
 n_hits information is present for the main and alternate S1s and S2s. 
Verify it works again on run 180215_1029. Hint: there are many ways to 
do it, but it can be done by only adding one line.<sup><a href="#fn__1" id="fnt__1" class="fn_top">1)</a></sup></div>
</li>
<li class="level1"><div class="li"> In a notebook, make a new plugin 
that reconstruct S2 positions as the position of the maximum PMT. (Hint:
 use straxen.pmt_positions.) Alternatively, reconstruct positions as the
 area-weighted mean of the hitpattern. (Hint: use np.average.) Reprocess
 run 180215_1029 and compare the resulting event positions. You can do 
this without changing the higher-level plugins that depend on 
peak_positions.</div>
</li>
</ul>

</div>
<div class="secedit editbutton_section editbutton_6"><form class="button btn_secedit" method="post" action="/doku.php"><div class="no"><input type="hidden" name="do" value="edit"><input type="hidden" name="rev" value="1595252004"><input type="hidden" name="summary" value="[Circle 1: High-level processing] "><input type="hidden" name="target" value="section"><input type="hidden" name="hid" value="circle_1high-level_processing"><input type="hidden" name="codeblockOffset" value="0"><input type="hidden" name="range" value="6875-9146"><input type="hidden" name="id" value="xenon:xenon1t:aalbers:straxferno"><button type="submit" title="Circle 1: High-level processing">Edit</button></div></form></div>
<h3 class="sectionedit7" id="circle_2low-level_processing">Circle 2: Low-level processing</h3>
<div class="level3">

<p>
Reading:
</p>
<ul>
<li class="level1 node"><div class="li"> <a href="https://github.com/XENONnT/straxen/blob/master/straxen/plugins/peaklet_processing.py" class="urlextern" title="https://github.com/XENONnT/straxen/blob/master/straxen/plugins/peaklet_processing.py" rel="nofollow">straxen/plugins/peaklet_processing.py</a> (342 lines)</div>
<ul>
<li class="level2"><div class="li"> Skip natural_breaks_threshold and get_merge_instructions, unless you are Joey/Evan/Joran;</div>
</li>
<li class="level2"><div class="li"> It might be helpful to review <a href="https://xe1t-wiki.lngs.infn.it/doku.php?id=xenon:xenonnt:analysis:strax_clustering_classification" class="wikilink1" title="xenon:xenonnt:analysis:strax_clustering_classification">the clustering/classification</a> note first.</div>
</li>
</ul>
</li>
<li class="level1 node"><div class="li"> <a href="https://github.com/XENONnT/straxen/blob/master/straxen/plugins/pulse_processing.py#L81" class="urlextern" title="https://github.com/XENONnT/straxen/blob/master/straxen/plugins/pulse_processing.py#L81" rel="nofollow">PulseProcessing</a> from <a href="https://github.com/XENONnT/straxen/blob/master/straxen/plugins/pulse_processing.py" class="urlextern" title="https://github.com/XENONnT/straxen/blob/master/straxen/plugins/pulse_processing.py" rel="nofollow">straxen/plugins/pulse_processing.py</a> (191 lines)</div>
<ul>
<li class="level2"><div class="li"> You can skip the functions defined 
below the class (e.g. software_he_veto, count_pulses, etc.) or not, 
depending on your interests.</div>
</li>
</ul>
</li>
</ul>

<p>
Study questions:
</p>
<ul>
<li class="level1"><div class="li"> Consider the different steps in PulseProcessing. Are there any whose order could be (inter)changed?</div>
</li>
<li class="level1"><div class="li"> Why are we doing find_hits twice? Are the results guaranteed to be the same?</div>
</li>
<li class="level1"><div class="li"> Why is the peakfinding a three-step process? Why do we do a rough gapsize clustering before natural breaks?</div>
</li>
<li class="level1"><div class="li"> Is any information lost when merging peaks together?</div>
</li>
<li class="level1"><div class="li"> What is the purpose of integrate_lone_hits?</div>
</li>
</ul>

<p>
As a homework exercise, we're going to split up the low-level processing algorithms in strax between each other. 
</p>
<ol>
<li class="level1 node"><div class="li"> <strong>Sign up</strong> for one of the strax functions in <a href="https://docs.google.com/spreadsheets/d/1-6tMF5jqAEi3RiyNoNnhyDHhVj8uFtObfm7lzdIvyvQ" class="urlextern" title="https://docs.google.com/spreadsheets/d/1-6tMF5jqAEi3RiyNoNnhyDHhVj8uFtObfm7lzdIvyvQ" rel="nofollow">this spreadsheet</a></div>
<ul>
<li class="level2"><div class="li"> Easy: O(10) lines. Choose this if you are new to strax, python or analysis.</div>
</li>
<li class="level2"><div class="li"> Medium: O(50) lines. Probably a few hours of work, suitable for most people.</div>
</li>
<li class="level2"><div class="li"> Hard: &gt; 100 lines. If you know strax already and want a challenge.</div>
</li>
</ul>
</li>
<li class="level1 node"><div class="li"> <strong>Study the function</strong>, answering e.g. the following questions:</div>
<ul>
<li class="level2"><div class="li"> Start with the docstring (if there is one!) and maybe skim the code first</div>
</li>
<li class="level2"><div class="li"> Find out where is it used. Look in strax and straxen. Compare with the docstring – what goes in, what goes out?</div>
</li>
<li class="level2"><div class="li"> How is it tested? Check the strax unit tests. If it isn't tested, can you think of a way to test it?</div>
</li>
<li class="level2 node"><div class="li"> Study through the implementation, paying special attention to comments. Anything unusual, risky, or remarkable?</div>
<ul>
<li class="level3"><div class="li"> If it helps, you could try to run the function in a notebook to try out some behaviors or modifications.</div>
</li>
</ul>
</li>
</ul>
</li>
<li class="level1 node"><div class="li"> <strong>Choose one of the following assignments</strong>:</div>
<ul>
<li class="level2"><div class="li"> A: Add <strong>one-slide</strong> on the function to <a href="https://docs.google.com/presentation/d/1sm20e6R6KMG-U4sEisDLmiKh0EU6LTjO2wyZ9clh7g8/" class="urlextern" title="https://docs.google.com/presentation/d/1sm20e6R6KMG-U4sEisDLmiKh0EU6LTjO2wyZ9clh7g8/" rel="nofollow">this presentation</a>, with a short summary, e.g. your answers to the questions above, or other things you would like to highlight.</div>
</li>
<li class="level2"><div class="li"> B: Make a <strong><a href="https://github.com/AxFoundation/strax/pulls" class="urlextern" title="https://github.com/AxFoundation/strax/pulls" rel="nofollow">strax pull request</a></strong> improving some part of the function. E.g. add some comments or a simple unit test. </div>
</li>
</ul>
</li>
</ol>

</div>
<div class="secedit editbutton_section editbutton_7"><form class="button btn_secedit" method="post" action="/doku.php"><div class="no"><input type="hidden" name="do" value="edit"><input type="hidden" name="rev" value="1595252004"><input type="hidden" name="summary" value="[Circle 2: Low-level processing] "><input type="hidden" name="target" value="section"><input type="hidden" name="hid" value="circle_2low-level_processing"><input type="hidden" name="codeblockOffset" value="0"><input type="hidden" name="range" value="9147-11980"><input type="hidden" name="id" value="xenon:xenon1t:aalbers:straxferno"><button type="submit" title="Circle 2: Low-level processing">Edit</button></div></form></div>
<h3 class="sectionedit8" id="circle_3loading_data_and_mini-analyses">Circle 3: Loading data and mini-analyses</h3>
<div class="level3">

<p>
Reading:
</p>
<ul>
<li class="level1 node"><div class="li"> plot_peak_classification from straxen/analyses/quick_checks.py (17 lines)</div>
<ul>
<li class="level2"><div class="li"> You can also look at other mini-analyses in the straxen/analyses folder, depending on your interests.</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> apply_selection, make, get_df, and get_array from context.py (122 lines)</div>
</li>
<li class="level1 node"><div class="li"> straxen/mini_analysis.py (175 lines)</div>
<ul>
<li class="level2"><div class="li"> If you're not familiar with python 
decorators, you may want to look up a tutorial while diving into this. 
(There are many, use your search engine)</div>
</li>
<li class="level2"><div class="li"> We also have documentation on mini-analyses <a href="https://straxen.readthedocs.io/en/latest/tutorials/mini_analyses.html" class="urlextern" title="https://straxen.readthedocs.io/en/latest/tutorials/mini_analyses.html" rel="nofollow">here</a>; apologies for the messy formatting.</div>
</li>
</ul>
</li>
<li class="level1 node"><div class="li"> <em>Optional, for those interested in the DAQ: straxen/plugins/daqreader.py (360 lines).</em></div>
<ul>
<li class="level2"><div class="li"> We may not discuss this in the discussion section; it will depend on time.</div>
</li>
</ul>
</li>
</ul>

<p>
Study questions:
</p>
<ul>
<li class="level1"><div class="li"> Give an example of when 
time_selection = 'touching' would be appropriate in an analysis or 
processing task, and the same for time_selection = 'fully_contained'. 
Can you think of other time selection conventions that might be useful?</div>
</li>
<li class="level1"><div class="li"> Why does <code>make</code> have a for loop that just does pass? How could you rewrite this as a list comprehension? Do you think this is a good idea?</div>
</li>
<li class="level1"><div class="li"> What is the use of selection_str 
option to get_array? Couldn't the user cut more easily cut data in their
 own notebook after the data is loaded?<sup><a href="#fn__2" id="fnt__2" class="fn_top">2)</a></sup></div>
</li>
<li class="level1"><div class="li"> What does straxen do if you make your mini-analysis take `t_reference` as an argument?</div>
</li>
<li class="level1"><div class="li"> Why does mini_analysis contain two nested function definitions? Could it not be done with one, or zero?</div>
</li>
</ul>

<p>
Exercises:
</p>
<ul>
<li class="level1"><div class="li"> Add a (hardcoded, simplified) 
blinding cut to strax: remove all events with cs1 &lt; 50 (if cs1 is 
present in the data being loaded).</div>
</li>
<li class="level1"><div class="li"> Create a mini-analysis to plot the rate of peaks over time during a run. How would you plot the rate of just S2s?</div>
</li>
<li class="level1"><div class="li"> Modify mini_analysis so that 
mini-analyses can be defined with an argument `user_defined_data`, which
 is True if the user passed in a data manually, and False if strax 
loaded new data. Test it with your mini-analysis above. Make sure it 
still works for mini-analyses that don't have this argument. </div>
</li>
</ul>

</div>
<div class="secedit editbutton_section editbutton_8"><form class="button btn_secedit" method="post" action="/doku.php"><div class="no"><input type="hidden" name="do" value="edit"><input type="hidden" name="rev" value="1595252004"><input type="hidden" name="summary" value="[Circle 3: Loading data and mini-analyses] "><input type="hidden" name="target" value="section"><input type="hidden" name="hid" value="circle_3loading_data_and_mini-analyses"><input type="hidden" name="codeblockOffset" value="0"><input type="hidden" name="range" value="11981-14304"><input type="hidden" name="id" value="xenon:xenon1t:aalbers:straxferno"><button type="submit" title="Circle 3: Loading data and mini-analyses">Edit</button></div></form></div>
<h3 class="sectionedit9" id="circle_4contexts_run_selection_and_configuration">Circle 4: Contexts, run selection, and configuration</h3>
<div class="level3">

<p>
Reading:
</p>
<ul>
<li class="level1 node"><div class="li"> <strong>Contexts</strong> (256 lines)</div>
<ul>
<li class="level2"><div class="li"> straxen/contexts.py: XENONnT part (first 100 lines). (Feel free to skim the rest.)</div>
</li>
<li class="level2"><div class="li"> strax/context.py: initial list of options, <code>__init__</code>, and <code>register</code> (156 lines)</div>
</li>
</ul>
</li>
<li class="level1 node"><div class="li"> <strong>Run selection</strong> (58 lines)</div>
<ul>
<li class="level2"><div class="li"> strax/context.py: get_meta, run_metadata, add_method (36 lines)</div>
</li>
<li class="level2 node"><div class="li"> strax/run_selection.py: select_runs (22 lines)</div>
<ul>
<li class="level3"><div class="li"> You may want to start by reviewing the <a href="https://straxen.readthedocs.io/en/latest/tutorials/run_selection.html" class="urlextern" title="https://straxen.readthedocs.io/en/latest/tutorials/run_selection.html" rel="nofollow">run selection demo</a> tutorial.</div>
</li>
</ul>
</li>
</ul>
</li>
<li class="level1 node"><div class="li"> <strong>Configuration</strong> (124 lines)</div>
<ul>
<li class="level2"><div class="li"> You may want to start by reviewing the <a href="https://straxen.readthedocs.io/en/latest/tutorials/strax_demo.html#Configuration-changes" class="urlextern" title="https://straxen.readthedocs.io/en/latest/tutorials/strax_demo.html#Configuration-changes" rel="nofollow">configuration changes</a> section of the main tutorial.</div>
</li>
<li class="level2"><div class="li"> There is also a useful configuration section in the <a href="https://strax.readthedocs.io/en/latest/advanced/plugin_dev.html#options-and-defaults" class="urlextern" title="https://strax.readthedocs.io/en/latest/advanced/plugin_dev.html#options-and-defaults" rel="nofollow">strax docs</a></div>
</li>
<li class="level2"><div class="li"> strax/context.py: _set_plugin_config (14 lines)</div>
</li>
<li class="level2"><div class="li"> strax/config.py: Option class (110 lines)</div>
</li>
</ul>
</li>
</ul>

<p>
Study questions:
</p>
<ul>
<li class="level1"><div class="li"> The DAQReader plugin not registered in every context. In which contexts is it omitted? Why?</div>
</li>
<li class="level1"><div class="li"> Suppose you are writing a plugin that takes an option. Why is it a bad idea to call your option <code>threshold</code>? Can you already find examples of badly named options in straxen?</div>
</li>
<li class="level1"><div class="li"> What is the difference between regular options and context options? Give an example of each. How do you modify them?</div>
</li>
<li class="level1"><div class="li"> What is the difference between run metadata and ordinary (data-level) metadata? Give an example of info you can find in each.</div>
</li>
<li class="level1"><div class="li"> Suppose you implement a per-run 
deadtime-corrected livetime calculation. Where would be the best place 
to store this information?</div>
</li>
</ul>

<p>
Exercises:
</p>
<ul>
<li class="level1"><div class="li"> Select all runs for which lone_hits are available, that are shorter than 10 minutes, and do not have a 'bad' tag.</div>
</li>
<li class="level1 node"><div class="li"> Load xenon1t_dali, then create a new context from it which:</div>
<ul>
<li class="level2"><div class="li"> Puts lone_hits for all runs into a dedicated folder (e.g. /home/yourusername/my_lone_hits);</div>
</li>
<li class="level2"><div class="li"> Allows building records, but not raw_records;</div>
</li>
<li class="level2"><div class="li"> Uses a hitfinder threshold of 50 ADC counts.</div>
</li>
<li class="level2"><div class="li"> Finally, process a tiny run (e.g. 180215_1029) with this. Compare the results with those of the default context.</div>
</li>
</ul>
</li>
<li class="level1 node"><div class="li"> Modify <code>register</code> to
 check that the defaults of the to-be-registered plugin's options are 
consistent with defaults specified by plugins that are already 
registered, and throw an exception otherwise.</div>
<ul>
<li class="level2"><div class="li"> If you are the first to do this, 
please make a pull request! If you're not, look through the pull request
 made by whoever was the first and see if you can suggest improvements.</div>
</li>
</ul>
</li>
</ul>

</div>
<div class="secedit editbutton_section editbutton_9"><form class="button btn_secedit" method="post" action="/doku.php"><div class="no"><input type="hidden" name="do" value="edit"><input type="hidden" name="rev" value="1595252004"><input type="hidden" name="summary" value="[Circle 4: Contexts, run selection, and configuration] "><input type="hidden" name="target" value="section"><input type="hidden" name="hid" value="circle_4contexts_run_selection_and_configuration"><input type="hidden" name="codeblockOffset" value="0"><input type="hidden" name="range" value="14305-16964"><input type="hidden" name="id" value="xenon:xenon1t:aalbers:straxferno"><button type="submit" title="Circle 4: Contexts, run selection, and configuration">Edit</button></div></form></div>
<h3 class="sectionedit10" id="circle_5the_storage_system">Circle 5: The storage system</h3>
<div class="level3">

<p>
Reading:
</p>
<ul>
<li class="level1"><div class="li"> Start with the <a href="https://strax.readthedocs.io/en/latest/developer/storage.html" class="urlextern" title="https://strax.readthedocs.io/en/latest/developer/storage.html" rel="nofollow">documentation page</a> on the storage system (apologies for the poor formatting)</div>
</li>
<li class="level1"><div class="li"> The entire storage system is too 
large to cover in one week. Below I listed the main functions of each 
the layers involved (most of them relatively small), which will at least
 give you an idea what is done where.</div>
</li>
<li class="level1 node"><div class="li"> <code>strax/contexts.py</code>: <code>is_stored</code>, <code>key_for</code>, <code>get_meta</code>, <code>_get_partial_loader_for</code></div>
<ul>
<li class="level2"><div class="li"> These are the main places a context interacts with its storage frontends.</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> <code>strax/storage/common.py</code>: DataKey, and from StorageFrontend: <code>__init__</code>, <code>loader</code>, <code>saver</code>, <code>get_metadata</code>; a quick glance at <code>find</code> and the abstract methods (<code>_scan_runs</code> and onwards).</div>
</li>
<li class="level1 node"><div class="li"> <code>strax/storage/files.py</code>: </div>
<ul>
<li class="level2"><div class="li"> from <code>DataDirectory</code>: <code>__init__</code> and <code>_find</code>;</div>
</li>
<li class="level2"><div class="li"> from <code>FileSytemBackend</code>: <code>_read_chunk</code>;</div>
</li>
<li class="level2"><div class="li"> from <code>FileSaver</code>: <code>__init__</code> and <code>_save_chunk</code>.</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> <code>strax/io.py</code>: <code>load_file</code> and <code>_load_file</code>.</div>
</li>
<li class="level1"><div class="li"> Optional, for those interested: have a look at straxen/rundb.py to see a different StorageFrontEnd in action.</div>
</li>
</ul>

<p>
Study questions:
</p>
<ul>
<li class="level1 node"><div class="li"> When you ask for data, 
different messages are passed through different layers of strax. Fill in
 the missing entries in the flow diagram below.</div>
<ul>
<li class="level2"><div class="li"> <code>User –[run_id + data_type]» Context –[…]» Storage FrontEnd –[…]» … –[…]» reading code in io.py</code></div>
</li>
</ul>
</li>
<li class="level1 node"><div class="li"> Which part(s) of the storage system would you need to change to implement the following?<sup><a href="#fn__3" id="fnt__3" class="fn_top">3)</a></sup></div>
<ul>
<li class="level2"><div class="li"> Support a new way of cataloguing which data is stored where (like the runs db or rucio)</div>
</li>
<li class="level2"><div class="li"> Support a new file format for storing data (e.g. csvs or ROOT trees)</div>
</li>
<li class="level2"><div class="li"> Support a different scheme of file 
organization, in which files for different runs are more or less 
randomly scattered across different folders, though there is some file 
or database tracking which file is where. (This is not hypothetical, 
unfortunately; it is what Rucio does to our files..)</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> Someone gives you a path to a folder
 which contains amazing data you want to read, unfortunately processed 
with some custom settings they did not tell you (and maybe some custom 
plugins too). How would you go about reading it in?</div>
</li>
</ul>

</div>
<div class="secedit editbutton_section editbutton_10"><form class="button btn_secedit" method="post" action="/doku.php"><div class="no"><input type="hidden" name="do" value="edit"><input type="hidden" name="rev" value="1595252004"><input type="hidden" name="summary" value="[Circle 5: The storage system] "><input type="hidden" name="target" value="section"><input type="hidden" name="hid" value="circle_5the_storage_system"><input type="hidden" name="codeblockOffset" value="0"><input type="hidden" name="range" value="16965-19356"><input type="hidden" name="id" value="xenon:xenon1t:aalbers:straxferno"><button type="submit" title="Circle 5: The storage system">Edit</button></div></form></div>
<h2 class="sectionedit11" id="inner_circles">Inner circles</h2>
<div class="level2">

</div>
<div class="secedit editbutton_section editbutton_11"><form class="button btn_secedit" method="post" action="/doku.php"><div class="no"><input type="hidden" name="do" value="edit"><input type="hidden" name="rev" value="1595252004"><input type="hidden" name="summary" value="[Inner circles] "><input type="hidden" name="target" value="section"><input type="hidden" name="hid" value="inner_circles"><input type="hidden" name="codeblockOffset" value="0"><input type="hidden" name="range" value="19357-19383"><input type="hidden" name="id" value="xenon:xenon1t:aalbers:straxferno"><button type="submit" title="Inner circles">Edit</button></div></form></div>
<h3 class="sectionedit12" id="circle_6chunks_and_plugins">Circle 6: Chunks and plugins</h3>
<div class="level3">

<p>
Reading:
</p>
<ul>
<li class="level1"><div class="li"> Documentation on the <a href="https://strax.readthedocs.io/en/latest/advanced/chunking.html" class="urlextern" title="https://strax.readthedocs.io/en/latest/advanced/chunking.html" rel="nofollow">strax data model</a></div>
</li>
<li class="level1"><div class="li"> from <code>strax/chunk.py</code>: the <code>Chunk</code> class (243 lines)</div>
</li>
<li class="level1 node"><div class="li"> from <code>strax/plugins.py</code>:</div>
<ul>
<li class="level2 node"><div class="li"> <code>Plugin</code> class, except <code>iter</code> and <code>cleanup</code>. (320 lines, focus on the big picture)</div>
<ul>
<li class="level3"><div class="li"> You probably want to refer to some example plugins from straxen as you are reading this. See circle 1 and 2.</div>
</li>
</ul>
</li>
<li class="level2 node"><div class="li"> <code>OverlapWindowPlugin</code>, <code>LoopPlugin</code>, and <code>MergeOnlyPlugin</code>. (165 lines)</div>
<ul>
<li class="level3"><div class="li"> We covered the outlines of this (from a user perspective) in circle 1 and 2.</div>
</li>
<li class="level3"><div class="li"> (Skip <code>ParallelSourcePlugin</code>. This is only used to parallelize online processing efficiently, and will make more sense to you in one of the final circles).</div>
</li>
</ul>
</li>
</ul>
</li>
</ul>

</div>
<div class="secedit editbutton_section editbutton_12"><form class="button btn_secedit" method="post" action="/doku.php"><div class="no"><input type="hidden" name="do" value="edit"><input type="hidden" name="rev" value="1595252004"><input type="hidden" name="summary" value="[Circle 6: Chunks and plugins] "><input type="hidden" name="target" value="section"><input type="hidden" name="hid" value="circle_6chunks_and_plugins"><input type="hidden" name="codeblockOffset" value="0"><input type="hidden" name="range" value="19384-20180"><input type="hidden" name="id" value="xenon:xenon1t:aalbers:straxferno"><button type="submit" title="Circle 6: Chunks and plugins">Edit</button></div></form></div>
<h3 class="sectionedit13" id="circle_7data_flow">Circle 7: Data flow</h3>
<div class="level3">
<ul>
<li class="level1"><div class="li"> From <code>strax/plugin.py</code>: <code>iter</code> and <code>cleanup</code> from the <code>Plugin</code> class</div>
</li>
<li class="level1 node"><div class="li"> From <code>strax/context.py</code>: <code>get_iter</code></div>
<ul>
<li class="level2"><div class="li"> Don't worry about GeneratorExit. If you are interested, see <a href="https://github.com/AxFoundation/strax/pull/252" class="urlextern" title="https://github.com/AxFoundation/strax/pull/252" rel="nofollow">issue 252</a>.</div>
</li>
</ul>
</li>
<li class="level1 node"><div class="li"> From <code>strax/processor.py</code>, <code>iter</code> method of <code>Processor</code> class</div>
<ul>
<li class="level2"><div class="li"> Don't worry too much about the first few lines involving mailboxes; we'll get to them in the final circle</div>
</li>
</ul>
</li>
</ul>

<p>
Study questions:
</p>
<ul>
<li class="level1"><div class="li"> What checks are in place to ensure plugins process all data from a run? </div>
</li>
<li class="level1"><div class="li"> What happens if data for one type stops (i.e. its last chunk has an endtime) a few milliseconds before another does?</div>
</li>
</ul>

<p>
Exercises:
</p>
<ul>
<li class="level1"><div class="li"> Add a progress bar to straxen, controlled by a context option. See issue <a href="https://github.com/AxFoundation/strax/issues/240" class="urlextern" title="https://github.com/AxFoundation/strax/issues/240" rel="nofollow">#240</a></div>
</li>
<li class="level1"><div class="li"> Consider issue <a href="https://github.com/AxFoundation/strax/issues/247" class="urlextern" title="https://github.com/AxFoundation/strax/issues/247" rel="nofollow">#247</a>. What is causing the problem? Any suggestion for fixing it?</div>
</li>
<li class="level1"><div class="li"> Consider issue <a href="https://github.com/AxFoundation/strax/issues/222" class="urlextern" title="https://github.com/AxFoundation/strax/issues/222" rel="nofollow">#222</a>.
 Can you think of a way to tracking and summarizing computation time per
 plugin? (Wouldn't advise putting too much work into implementing it, 
Yossi is already looking at solutions at the streaming level that may 
make this easier.)</div>
</li>
</ul>

</div>
<div class="secedit editbutton_section editbutton_13"><form class="button btn_secedit" method="post" action="/doku.php"><div class="no"><input type="hidden" name="do" value="edit"><input type="hidden" name="rev" value="1595252004"><input type="hidden" name="summary" value="[Circle 7: Data flow] "><input type="hidden" name="target" value="section"><input type="hidden" name="hid" value="circle_7data_flow"><input type="hidden" name="codeblockOffset" value="0"><input type="hidden" name="range" value="20181-21458"><input type="hidden" name="id" value="xenon:xenon1t:aalbers:straxferno"><button type="submit" title="Circle 7: Data flow">Edit</button></div></form></div>
<h3 class="sectionedit14" id="circle_8processing_initialization">Circle 8: Processing initialization</h3>
<div class="level3">
<ul>
<li class="level1"><div class="li"> get_components and _get_plugins from context.py</div>
</li>
</ul>

<p>
Study questions (sorry for adding them late, we'll go through them 
during the discussion section if there are no more important questions).
</p>
<ul>
<li class="level1 node"><div class="li"> Please put the following significant events in the lifecycle of a plugin in order:</div>
<ul>
<li class="level2"><div class="li"> Call to __init__</div>
</li>
<li class="level2"><div class="li"> Calls to do_compute</div>
</li>
<li class="level2"><div class="li"> Setting complete configuration</div>
</li>
<li class="level2"><div class="li"> Setting default for data_kind if it is absent</div>
</li>
<li class="level2"><div class="li"> Calling infer_dtype if needed</div>
</li>
<li class="level2"><div class="li"> Setting run_id attribute</div>
</li>
<li class="level2"><div class="li"> Setting default for provides if it is absent</div>
</li>
<li class="level2"><div class="li"> Call to setup</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> Why is set_plugin_config called twice for each plugin?</div>
</li>
<li class="level1"><div class="li"> Find the following code goofs: an usused variable, and two f-strings without an f. PRs welcome <img src="course_info_files/icon_smile.gif" class="icon" alt=":-)"></div>
</li>
</ul>

</div>
<div class="secedit editbutton_section editbutton_14"><form class="button btn_secedit" method="post" action="/doku.php"><div class="no"><input type="hidden" name="do" value="edit"><input type="hidden" name="rev" value="1595252004"><input type="hidden" name="summary" value="[Circle 8: Processing initialization] "><input type="hidden" name="target" value="section"><input type="hidden" name="hid" value="circle_8processing_initialization"><input type="hidden" name="codeblockOffset" value="0"><input type="hidden" name="range" value="21459-22229"><input type="hidden" name="id" value="xenon:xenon1t:aalbers:straxferno"><button type="submit" title="Circle 8: Processing initialization">Edit</button></div></form></div>
<h3 class="sectionedit15" id="circle_9mailboxes_and_the_threadedmailboxprocessor">Circle 9: Mailboxes and the ThreadedMailboxProcessor</h3>
<div class="level3">
<ul>
<li class="level1"><div class="li"> __init_ from processor.py</div>
</li>
<li class="level1 node"><div class="li"> mailboxes.py, as long as you can stand its baleful gaze.</div>
<ul>
<li class="level2"><div class="li"> The descriptions <a href="https://github.com/AxFoundation/strax/issues/81#issuecomment-589542967" class="urlextern" title="https://github.com/AxFoundation/strax/issues/81#issuecomment-589542967" rel="nofollow">here</a> and <a href="https://strax.readthedocs.io/en/latest/developer/pipeline.html" class="urlextern" title="https://strax.readthedocs.io/en/latest/developer/pipeline.html" rel="nofollow">here</a> might be helpful</div>
</li>
</ul>
</li>
</ul>

<p>
Study / discussion questions:
</p>
<ul>
<li class="level1"><div class="li"> Describe the three conditions in 
which a mailbox can be locked / initiate a waiting period. What triggers
 them? What resolves them?</div>
</li>
<li class="level1"><div class="li"> Does a mailbox have one or more senders? Does it have one or more subscribers? How do multi-output plugins fit in to this?</div>
</li>
<li class="level1"><div class="li"> Consider an output like lone_hits 
which is not required by other plugins. How is this mailbox emptied? 
What if lone_hits were also not saved?</div>
</li>
<li class="level1"><div class="li"> Suppose an exception occurs in a 
plugin's compute. Describe the steps that occur to handle this 
exception, until strax has shut down.</div>
</li>
</ul>

</div>
<div class="secedit editbutton_section editbutton_15"><form class="button btn_secedit" method="post" action="/doku.php"><div class="no"><input type="hidden" name="do" value="edit"><input type="hidden" name="rev" value="1595252004"><input type="hidden" name="summary" value="[Circle 9: Mailboxes and the ThreadedMailboxProcessor] "><input type="hidden" name="target" value="section"><input type="hidden" name="hid" value="circle_9mailboxes_and_the_threadedmailboxprocessor"><input type="hidden" name="codeblockOffset" value="0"><input type="hidden" name="range" value="22230-"><input type="hidden" name="id" value="xenon:xenon1t:aalbers:straxferno"><button type="submit" title="Circle 9: Mailboxes and the ThreadedMailboxProcessor">Edit</button></div></form></div><div class="footnotes">
<div class="fn"><sup><a href="#fnt__1" id="fn__1" class="fn_bot">1)</a></sup> 
<div class="content">… and incrementing a version number</div></div>
<div class="fn"><sup><a href="#fnt__2" id="fn__2" class="fn_bot">2)</a></sup> 
<div class="content">You might need to peek inside get_iter to answer 
this. Don't get lost in there though, there is a lot of stuff we won't 
discuss until much later</div></div>
<div class="fn"><sup><a href="#fnt__3" id="fn__3" class="fn_bot">3)</a></sup> 
<div class="content">Just to avoid all mistunderstanding, of course I'm  not asking you to actually implement these as a study question!</div></div>
</div>

                    <!-- wikipage stop -->
                                    </div>

                <div class="docInfo"><bdi>xenon/xenon1t/aalbers/straxferno.txt</bdi> · Last modified: 2020/07/20 15:33 by <bdi>feigao</bdi></div>

                            </div></div><!-- /content -->

            <hr class="a11y">

            <!-- PAGE ACTIONS -->
            <div id="dokuwiki__pagetools">
                <h3 class="a11y">Page Tools</h3>
                <div class="tools">
                    <ul>
                        <li class="edit"><a href="https://xe1t-wiki.lngs.infn.it/doku.php?id=xenon:xenon1t:aalbers:straxferno&amp;do=edit" title="Edit this page [e]" rel="nofollow" accesskey="e"><span>Edit this page</span><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"></path></svg></a></li><li class="revs"><a href="https://xe1t-wiki.lngs.infn.it/doku.php?id=xenon:xenon1t:aalbers:straxferno&amp;do=revisions" title="Old revisions [o]" rel="nofollow" accesskey="o"><span>Old revisions</span><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M11 7v5.11l4.71 2.79.79-1.28-4-2.37V7m0-5C8.97 2 5.91 3.92 4.27 6.77L2 4.5V11h6.5L5.75 8.25C6.96 5.73 9.5 4 12.5 4a7.5 7.5 0 0 1 7.5 7.5 7.5 7.5 0 0 1-7.5 7.5c-3.27 0-6.03-2.09-7.06-5h-2.1c1.1 4.03 4.77 7 9.16 7 5.24 0 9.5-4.25 9.5-9.5A9.5 9.5 0 0 0 12.5 2z"></path></svg></a></li><li class="backlink"><a href="https://xe1t-wiki.lngs.infn.it/doku.php?id=xenon:xenon1t:aalbers:straxferno&amp;do=backlink" title="Backlinks" rel="nofollow"><span>Backlinks</span><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M10.59 13.41c.41.39.41 1.03 0 1.42-.39.39-1.03.39-1.42 0a5.003 5.003 0 0 1 0-7.07l3.54-3.54a5.003 5.003 0 0 1 7.07 0 5.003 5.003 0 0 1 0 7.07l-1.49 1.49c.01-.82-.12-1.64-.4-2.42l.47-.48a2.982 2.982 0 0 0 0-4.24 2.982 2.982 0 0 0-4.24 0l-3.53 3.53a2.982 2.982 0 0 0 0 4.24m2.82-4.24c.39-.39 1.03-.39 1.42 0a5.003 5.003 0 0 1 0 7.07l-3.54 3.54a5.003 5.003 0 0 1-7.07 0 5.003 5.003 0 0 1 0-7.07l1.49-1.49c-.01.82.12 1.64.4 2.43l-.47.47a2.982 2.982 0 0 0 0 4.24 2.982 2.982 0 0 0 4.24 0l3.53-3.53a2.982 2.982 0 0 0 0-4.24.973.973 0 0 1 0-1.42z"></path></svg></a></li><li class="export_pdf"><a href="https://xe1t-wiki.lngs.infn.it/doku.php?id=xenon:xenon1t:aalbers:straxferno&amp;do=export_pdf" title="Export to PDF" rel="nofollow"><span>Export to PDF</span><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M14 9h5.5L14 3.5V9M7 2h8l6 6v12a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2m4.93 10.44c.41.9.93 1.64 1.53 2.15l.41.32c-.87.16-2.07.44-3.34.93l-.11.04.5-1.04c.45-.87.78-1.66 1.01-2.4m6.48 3.81c.18-.18.27-.41.28-.66.03-.2-.02-.39-.12-.55-.29-.47-1.04-.69-2.28-.69l-1.29.07-.87-.58c-.63-.52-1.2-1.43-1.6-2.56l.04-.14c.33-1.33.64-2.94-.02-3.6a.853.853 0 0 0-.61-.24h-.24c-.37 0-.7.39-.79.77-.37 1.33-.15 2.06.22 3.27v.01c-.25.88-.57 1.9-1.08 2.93l-.96 1.8-.89.49c-1.2.75-1.77 1.59-1.88 2.12-.04.19-.02.36.05.54l.03.05.48.31.44.11c.81 0 1.73-.95 2.97-3.07l.18-.07c1.03-.33 2.31-.56 4.03-.75 1.03.51 2.24.74 3 .74.44 0 .74-.11.91-.3m-.41-.71l.09.11c-.01.1-.04.11-.09.13h-.04l-.19.02c-.46 0-1.17-.19-1.9-.51.09-.1.13-.1.23-.1 1.4 0 1.8.25 1.9.35M8.83 17c-.65 1.19-1.24 1.85-1.69 2 .05-.38.5-1.04 1.21-1.69l.48-.31m3.02-6.91c-.23-.9-.24-1.63-.07-2.05l.07-.12.15.05c.17.24.19.56.09 1.1l-.03.16-.16.82-.05.04z"></path></svg></a></li><li class="menuitem"><a href="https://xe1t-wiki.lngs.infn.it/doku.php?id=xenon:xenon1t:aalbers:straxferno&amp;do=menuitem" title="Rename Page" rel="nofollow" class=" plugin_move_page "><span>Rename Page</span><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M18,4V3A1,1 0 0,0 17,2H5A1,1 0 0,0 4,3V7A1,1 0 0,0 5,8H17A1,1 0 0,0 18,7V6H19V10H9V21A1,1 0 0,0 10,22H12A1,1 0 0,0 13,21V12H21V4H18Z"></path></svg></a></li><li class="top"><a href="#dokuwiki__top" title="Back to top [t]" rel="nofollow" accesskey="t"><span>Back to top</span><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path></svg></a></li>                    </ul>
                </div>
            </div>
        </div><!-- /wrapper -->

        
<!-- ********** FOOTER ********** -->
<div id="dokuwiki__footer"><div class="pad">
    <div class="license">Except where otherwise noted, content on this wiki is licensed under the following license: <bdi><a href="http://creativecommons.org/licenses/by-sa/4.0/" rel="license" class="urlextern">CC Attribution-Share Alike 4.0 International</a></bdi></div>
    <div class="buttons">
        <a href="http://creativecommons.org/licenses/by-sa/4.0/" rel="license"><img src="course_info_files/cc-by-sa.png" alt="CC Attribution-Share Alike 4.0 International"></a>        <a href="https://www.dokuwiki.org/donate" title="Donate"><img src="course_info_files/button-donate.gif" alt="Donate" width="80" height="15"></a>
        <a href="https://php.net/" title="Powered by PHP"><img src="course_info_files/button-php.gif" alt="Powered by PHP" width="80" height="15"></a>
        <a href="https://validator.w3.org/check/referer" title="Valid HTML5"><img src="course_info_files/button-html5.png" alt="Valid HTML5" width="80" height="15"></a>
        <a href="https://jigsaw.w3.org/css-validator/check/referer?profile=css3" title="Valid CSS"><img src="course_info_files/button-css.png" alt="Valid CSS" width="80" height="15"></a>
        <a href="https://dokuwiki.org/" title="Driven by DokuWiki"><img src="course_info_files/button-dw.png" alt="Driven by DokuWiki" width="80" height="15"></a>
    </div>
</div></div><!-- /footer -->

    </div></div><!-- /site -->

    <div class="no"><img src="course_info_files/indexer.gif" alt="" width="2" height="1"></div>
    <div id="screen__mode" class="no"></div>

</body></html>